{% extends "base.html" %}
{% load static %}

{% block title %}Firmware Flasher - MeshCore{% endblock %}

{% block page_title %}Firmware Flasher{% endblock %}

{% block header_actions %}
<a href="https://github.com/ripplebiz/MeshCore/wiki/Repeater-&-Room-Server-CLI-Reference" target="_blank" class="btn btn-secondary">
    <i class="fas fa-book"></i>
    CLI Reference
</a>
{% endblock %}

{% block content %}
<div id="flasher-app" v-cloak>
    <!-- Device Selection -->
    <div v-if="!selectedDevice && !flashing">
        <div class="mb-3">
            <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Select Your Device</h2>
            <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Choose the device you want to flash with MeshCore firmware</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
            <div v-for="device in devices" :key="device.id" 
                 class="card"
                 style="cursor: pointer; transition: all 0.15s;"
                 @click="selectDevice(device)"
                 @mouseover="$event.currentTarget.style.transform = 'translateY(-2px)'"
                 @mouseout="$event.currentTarget.style.transform = 'translateY(0)'">
                <div style="height: 160px; display: flex; align-items: center; justify-content: center; background: hsl(var(--secondary)); border-radius: var(--radius) var(--radius) 0 0; padding: 1.5rem;">
                    <img :src="device.image" :alt="device.name" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                </div>
                <div style="padding: 1rem;">
                    <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">[[ device.name ]]</h3>
                    <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">[[ device.description ]]</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firmware Selection -->
    <div v-if="selectedDevice && !selectedFirmware && !flashing">
        <div class="mb-3">
            <button class="btn btn-ghost" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;" @click="selectedDevice = null">
                <i class="fas fa-arrow-left"></i>
                Back to Devices
            </button>
        </div>

        <div class="card mb-3">
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem;">
                <img :src="selectedDevice.image" :alt="selectedDevice.name" style="width: 64px; height: 64px; object-fit: contain;">
                <div>
                    <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">[[ selectedDevice.name ]]</h2>
                    <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">[[ selectedDevice.description ]]</p>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Select Firmware Role</h3>
            <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">Choose the role for your device</p>
        </div>

        <div style="display: grid; gap: 0.5rem;">
            <div v-for="firmware in selectedDevice.firmwares" :key="firmware.id"
                 class="card"
                 style="cursor: pointer; transition: all 0.15s;"
                 @click="selectFirmware(firmware)"
                 @mouseover="$event.currentTarget.style.transform = 'translateY(-1px)'"
                 @mouseout="$event.currentTarget.style.transform = 'translateY(0)'">
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: hsl(var(--primary) / 0.15); color: hsl(var(--primary)); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i :class="firmware.icon"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.125rem;">[[ firmware.name ]]</h4>
                        <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">[[ firmware.description ]]</p>
                    </div>
                    <i class="fas fa-chevron-right" style="color: hsl(var(--muted-foreground)); font-size: 0.75rem;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Configuration -->
    <div v-if="selectedFirmware && !flashing">
        <div class="mb-3">
            <button class="btn btn-ghost" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;" @click="selectedFirmware = null">
                <i class="fas fa-arrow-left"></i>
                Back to Firmware Selection
            </button>
        </div>

        <div class="card mb-3">
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem;">
                <div style="width: 56px; height: 56px; border-radius: 50%; background: hsl(var(--primary) / 0.15); color: hsl(var(--primary)); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i :class="selectedFirmware.icon" style="font-size: 1.5rem;"></i>
                </div>
                <div style="flex: 1;">
                    <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">[[ selectedFirmware.name ]]</h2>
                    <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">[[ selectedDevice.name ]]</p>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div style="padding: 0.75rem;">
                <label style="display: block; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">Firmware Version</label>
                <select v-model="selectedVersion" style="width: 100%; padding: 0.5rem 0.75rem; background: hsl(var(--secondary)); border: 1px solid hsl(var(--border)); border-radius: var(--radius); color: hsl(var(--foreground)); font-size: 0.875rem;">
                    <option v-for="(versionData, versionKey) in selectedFirmware.versions" 
                            :key="versionKey" 
                            :value="versionKey">
                        [[ versionData.version ]] - [[ versionData.notes ]]
                    </option>
                </select>
            </div>
        </div>

        <div class="card mb-3" v-if="selectedDevice.type === 'esp32'" style="background: hsl(var(--warning) / 0.1); border-color: hsl(var(--warning) / 0.3);">
            <div style="padding: 0.75rem;">
                <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer;">
                    <input type="checkbox" v-model="eraseDevice" style="width: 1rem; height: 1rem; margin-top: 0.125rem; flex-shrink: 0;">
                    <div>
                        <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">Erase Device</div>
                        <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                            ⚠️ DO NOT erase if simply updating. This will erase your MeshCore identity.
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <div class="card mb-3" v-if="selectedDevice.type === 'nrf52'" style="background: hsl(var(--primary) / 0.05); border-color: hsl(var(--primary) / 0.2);">
            <div style="padding: 0.75rem;">
                <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <i class="fas fa-info-circle" style="color: hsl(var(--primary)); margin-top: 0.125rem;"></i>
                    <div style="font-size: 0.75rem;">
                        <strong>DFU Mode Required:</strong> Your RAK4631 must be in DFU (Device Firmware Update) mode to flash.
                    </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;" @click="enterDfuMode" :disabled="dfuActive">
                    <i :class="dfuActive ? 'fas fa-check' : 'fas fa-code'"></i>
                    [[ dfuActive ? 'DFU Mode Active' : 'Enter DFU Mode' ]]
                </button>
            </div>
        </div>

        <button class="btn btn-primary" style="width: 100%;" @click="startFlashing" :disabled="!canFlash">
            <i class="fas fa-bolt"></i>
            Flash Firmware
        </button>
    </div>

    <!-- Flashing Progress -->
    <div v-if="flashing">
        <div class="card">
            <div style="padding: 2rem; text-align: center;">
                <div v-if="flashError">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Flashing Failed</h3>
                    <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 1rem;">[[ flashError ]]</p>
                    <button class="btn btn-primary" @click="resetFlasher">
                        <i class="fas fa-redo"></i>
                        Try Again
                    </button>
                </div>
                <div v-else-if="flashProgress < 100">
                    <div class="spinner mb-3"></div>
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Flashing Firmware...</h3>
                    <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 1rem;">Please do not disconnect your device</p>
                    <div class="progress-bar mb-2">
                        <div class="progress-fill" :style="{width: flashProgress + '%'}"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">[[ flashProgress ]]%</div>
                </div>
                <div v-else>
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #22c55e; margin-bottom: 1rem;"></i>
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Flashing Complete!</h3>
                    <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 1rem;">Your device has been successfully flashed</p>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="btn btn-secondary" @click="resetFlasher">
                            <i class="fas fa-home"></i>
                            Flash Another Device
                        </button>
                        <button class="btn btn-primary" @click="openConsole">
                            <i class="fas fa-terminal"></i>
                            Open Console
                        </button>
                    </div>
                </div>
            </div>
            
            <div v-if="flashLog.length > 0" style="border-top: 1px solid hsl(var(--border));">
                <div style="padding: 0.75rem;">
                    <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Flash Log</h4>
                    <div class="console-output">
                        <div v-for="(log, index) in flashLog" :key="index" class="console-line">
                            [[ log ]]
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Console Modal -->
    <div v-if="showConsole" class="modal-overlay" @click.self="showConsole = false">
        <div class="card" style="max-width: 800px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                <h3 style="font-size: 1rem; font-weight: 600;">Serial Console</h3>
                <button @click="showConsole = false" style="width: 32px; height: 32px; border-radius: 50%; background: hsl(var(--secondary)); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: hsl(var(--foreground));">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 1rem; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div class="console-output mb-3" style="flex: 1; overflow-y: auto;">
                    <div v-for="(line, index) in consoleOutput" :key="index" class="console-line">
                        [[ line ]]
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <input 
                        v-model="consoleCommand" 
                        @keyup.enter="sendCommand"
                        type="text" 
                        style="flex: 1; padding: 0.5rem 0.75rem; background: hsl(var(--secondary)); border: 1px solid hsl(var(--border)); border-radius: var(--radius); color: hsl(var(--foreground)); font-size: 0.875rem;"
                        placeholder="Enter command...">
                    <button class="btn btn-primary" @click="sendCommand">
                        <i class="fas fa-paper-plane"></i>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
[v-cloak] { display: none; }

.mb-2 { margin-bottom: 0.5rem; }
.mb-3 { margin-bottom: 0.75rem; }

.spinner {
    width: 48px;
    height: 48px;
    border: 4px solid hsl(var(--secondary));
    border-top-color: hsl(var(--primary));
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: hsl(var(--secondary));
    border-radius: 999px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--primary) / 0.8));
    transition: width 0.3s ease;
}

.console-output {
    background: #000;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius);
    max-height: 300px;
    overflow-y: auto;
}

.console-line {
    margin-bottom: 0.25rem;
    word-wrap: break-word;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
</style>

<script type="module">
import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
import { ESPLoader, Transport } from '{% static "js/flasher/esp32.js" %}';
import { Dfu } from '{% static "js/flasher/dfu.js" %}';

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            devices: [],
            selectedDevice: null,
            selectedFirmware: null,
            selectedVersion: 'latest',
            eraseDevice: false,
            dfuActive: false,
            flashing: false,
            flashProgress: 0,
            flashError: null,
            flashLog: [],
            showConsole: false,
            consoleOutput: [],
            consoleCommand: '',
            port: null,
            transport: null,
            esploader: null,
            dfu: null
        }
    },
    computed: {
        canFlash() {
            if (this.selectedDevice.type === 'nrf52') {
                return this.dfuActive;
            }
            return true;
        }
    },
    async mounted() {
        await this.loadFirmwareConfig();
        this.checkWebAPIs();
    },
    methods: {
        checkWebAPIs() {
            if (!('serial' in navigator)) {
                console.warn('Web Serial API not supported');
            }
            if (!('usb' in navigator)) {
                console.warn('Web USB API not supported');
            }
        },
        async loadFirmwareConfig() {
            try {
                const response = await fetch('/static/firmware_config.json');
                const config = await response.json();
                this.devices = config.devices;
            } catch (error) {
                console.error('Failed to load firmware config:', error);
                this.flashError = 'Failed to load firmware configuration';
            }
        },
        selectDevice(device) {
            this.selectedDevice = device;
        },
        selectFirmware(firmware) {
            this.selectedFirmware = firmware;
            this.selectedVersion = 'latest';
        },
        async enterDfuMode() {
            try {
                this.flashLog.push('Requesting USB device access...');
                
                // Request USB device (Nordic nRF52 DFU)
                const device = await navigator.usb.requestDevice({
                    filters: [{ vendorId: 0x1915 }] // Nordic Semiconductor
                });
                
                this.flashLog.push('USB device connected');
                this.flashLog.push('Checking for DFU mode...');
                
                // Initialize DFU
                this.dfu = new Dfu(device);
                await this.dfu.init();
                
                this.dfuActive = true;
                this.flashLog.push('✓ DFU mode active!');
                
            } catch (error) {
                this.flashLog.push(`Error: ${error.message}`);
                this.flashLog.push('Please double-press the reset button on your RAK4631');
            }
        },
        async startFlashing() {
            this.flashing = true;
            this.flashProgress = 0;
            this.flashError = null;
            this.flashLog = [];

            try {
                if (this.selectedDevice.type === 'esp32') {
                    await this.flashESP32();
                } else if (this.selectedDevice.type === 'nrf52') {
                    await this.flashNRF52();
                }
                
                this.flashLog.push('✓ Firmware flashed successfully!');
                this.flashProgress = 100;
                
            } catch (error) {
                this.flashError = error.message;
                this.flashLog.push(`✗ Error: ${error.message}`);
            }
        },
        async flashESP32() {
            // Check for Web Serial API support
            if (!('serial' in navigator)) {
                throw new Error('Web Serial API not supported. Please use Chrome, Edge, or Opera.');
            }

            this.flashLog.push('Requesting serial port access...');
            
            // Request serial port
            this.port = await navigator.serial.requestPort();
            await this.port.open({ baudRate: 115200 });
            
            this.flashLog.push('✓ Serial port opened');
            this.flashLog.push('Connecting to ESP32...');
            
            // Initialize transport and ESP loader
            this.transport = new Transport(this.port);
            this.esploader = new ESPLoader(this.transport, 115200);
            
            // Connect to ESP32
            const chip = await this.esploader.main_fn();
            this.flashLog.push(`✓ Connected to ${chip}`);
            
            // Get firmware URL
            const firmwareUrl = this.selectedFirmware.versions[this.selectedVersion].url;
            this.flashLog.push(`Downloading firmware from ${firmwareUrl}...`);
            
            // Download firmware
            const response = await fetch(firmwareUrl);
            const firmwareData = await response.arrayBuffer();
            
            this.flashLog.push('✓ Firmware downloaded');
            
            // Erase flash if requested
            if (this.eraseDevice) {
                this.flashLog.push('Erasing flash...');
                await this.esploader.erase_flash();
                this.flashLog.push('✓ Flash erased');
            }
            
            // Flash firmware
            this.flashLog.push('Flashing firmware...');
            
            await this.esploader.write_flash({
                fileArray: [{data: firmwareData, address: 0x0}],
                flashSize: 'keep',
                flashMode: 'keep',
                flashFreq: 'keep',
                eraseAll: this.eraseDevice,
                compress: true,
                reportProgress: (fileIndex, written, total) => {
                    this.flashProgress = Math.round((written / total) * 100);
                }
            });
            
            // Reset device
            this.flashLog.push('Resetting device...');
            await this.esploader.hard_reset();
            
            // Close port
            await this.port.close();
            
        },
        async flashNRF52() {
            if (!this.dfu) {
                throw new Error('DFU not initialized. Please enter DFU mode first.');
            }
            
            // Get firmware URL
            const firmwareUrl = this.selectedFirmware.versions[this.selectedVersion].url;
            this.flashLog.push(`Downloading firmware from ${firmwareUrl}...`);
            
            // Download firmware ZIP
            const response = await fetch(firmwareUrl);
            const firmwareZip = await response.blob();
            
            this.flashLog.push('✓ Firmware downloaded');
            this.flashLog.push('Flashing via DFU...');
            
            // Flash firmware
            await this.dfu.flash(firmwareZip, (progress) => {
                this.flashProgress = Math.round(progress * 100);
            });
            
            this.flashLog.push('✓ DFU transfer complete');
        },
        resetFlasher() {
            this.selectedDevice = null;
            this.selectedFirmware = null;
            this.selectedVersion = 'latest';
            this.eraseDevice = false;
            this.dfuActive = false;
            this.flashing = false;
            this.flashProgress = 0;
            this.flashError = null;
            this.flashLog = [];
            this.port = null;
            this.transport = null;
            this.esploader = null;
            this.dfu = null;
        },
        async openConsole() {
            this.showConsole = true;
            this.consoleOutput = ['Console ready. Type a command and press Enter.', ''];
            
            try {
                // Reopen serial port for console
                if (!this.port) {
                    this.port = await navigator.serial.requestPort();
                }
                
                if (!this.port.readable) {
                    await this.port.open({ baudRate: 115200 });
                }
                
                this.consoleOutput.push('✓ Serial port connected');
                
                // Start reading from serial
                this.readSerial();
                
            } catch (error) {
                this.consoleOutput.push(`Error: ${error.message}`);
            }
        },
        async readSerial() {
            try {
                const reader = this.port.readable.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = decoder.decode(value);
                    this.consoleOutput.push(text);
                }
                
                reader.releaseLock();
            } catch (error) {
                console.error('Serial read error:', error);
            }
        },
        async sendCommand() {
            if (!this.consoleCommand.trim()) return;
            
            this.consoleOutput.push(`> ${this.consoleCommand}`);
            
            try {
                if (this.port && this.port.writable) {
                    const writer = this.port.writable.getWriter();
                    const encoder = new TextEncoder();
                    await writer.write(encoder.encode(this.consoleCommand + '\r\n'));
                    writer.releaseLock();
                }
            } catch (error) {
                this.consoleOutput.push(`Error: ${error.message}`);
            }
            
            this.consoleCommand = '';
        }
    }
}).mount('#flasher-app');
</script>

{% endblock %}
