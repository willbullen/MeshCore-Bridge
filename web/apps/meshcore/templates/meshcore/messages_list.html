{% extends "base.html" %}

{% block title %}Messages - MeshCore Bridge{% endblock %}
{% block page_title %}Messages{% endblock %}

{% block header_actions %}
<div class="flex gap-2">
    <select class="form-select" style="width: auto; padding: 0.375rem 0.75rem; font-size: 0.8125rem;" onchange="window.location.href='?type=' + this.value">
        <option value="">All Types</option>
        {% for type_choice in message_types %}
        <option value="{{ type_choice.0 }}" {% if msg_type == type_choice.0 %}selected{% endif %}>{{ type_choice.1 }}</option>
        {% endfor %}
    </select>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div style="max-height: calc(100vh - 200px); overflow-y: auto;">
        {% for message in messages %}
        <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border)); display: flex; gap: 1rem;">
            <div style="flex: 1; min-width: 0;">
                <div class="flex items-center gap-2 mb-2">
                    <span class="badge badge-secondary">{{ message.message_type }}</span>
                    <span class="text-sm font-medium">{{ message.sender.name|default:message.sender.node_hash }}</span>
                    {% if message.to_node %}
                    <i class="fas fa-arrow-right text-xs text-muted"></i>
                    <span class="text-sm text-muted">{{ message.recipient.name|default:message.recipient.node_hash }}</span>
                    {% endif %}
                </div>
                
                {% if message.text_content %}
                <div class="text-sm mb-2" style="word-break: break-word;">{{ message.text_content }}</div>
                {% endif %}
                
                <div class="flex items-center gap-4 text-xs text-muted">
                    {% if message.snr %}
                    <span><i class="fas fa-signal"></i> SNR: {{ message.snr }} dB</span>
                    {% endif %}
                    {% if message.rssi %}
                    <span><i class="fas fa-broadcast-tower"></i> RSSI: {{ message.rssi }} dBm</span>
                    {% endif %}
                    <span><i class="fas fa-hashtag"></i> Channel: {{ message.channel }}</span>
                    {% if message.published_to_mqtt %}
                    <span class="badge badge-success" style="font-size: 0.65rem; padding: 0.125rem 0.375rem;">
                        <i class="fas fa-check"></i> Published
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                <span class="text-xs text-muted" style="white-space: nowrap;">{{ message.rx_time|timesince }} ago</span>
                <span class="text-xs text-muted">{{ message.rx_time|date:"M d, H:i" }}</span>
            </div>
        </div>
        {% empty %}
        <div style="padding: 3rem; text-align: center;">
            <i class="fas fa-comments" style="font-size: 3rem; color: hsl(var(--muted-foreground)); margin-bottom: 1rem;"></i>
            <p class="text-muted">No messages found</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
